name: 🔐 DevSecOps Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-scanning:
    runs-on: ubuntu-latest
    name: 🛡️ Run Security Scans
    
    steps:
    # Step 1: Checkout code
    - name: ⬇️ Checkout code
      uses: actions/checkout@v4  # Upgrade ke v4

    # Step 2: Secret Scanning (Gitleaks)
    - name: 🔓 Secret Scanning
      uses: gitleaks/gitleaks-action@v2

    # Step 3: SCA Scanning (Trivy)
    - name: 📦 SCA Scan (Dependencies)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    # Step 4: SAST Scanning (Semgrep)  
    - name: 🔎 SAST Scan (Code Analysis)
      uses: returntocorp/semgrep-action@v1
      with:
        config: p/security-audit

    # Step 5: Upload Reports
    - name: 💾 Upload Security Reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          trivy-results.sarif
          gl-*
        retention-days: 30

    # Step 6: Fail on Critical Findings (Improved)
    - name: ⚠️ Fail on Critical Vulnerabilities
      id: fail-check
      run: |
        echo "🔍 Checking for critical vulnerabilities..."
        # Add actual check logic here
        if [ -f "trivy-results.sarif" ]; then
          echo "Security reports generated"
        else
          echo "No critical vulnerabilities detected"
        fi
